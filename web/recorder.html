</head>

<body>

    <main>
        <button id="start-recording">Start Recording</button>
        <button id="stop-recording">Stop Recording</button>
    </main>

    <script>
        window.addEventListener('load', function() {
            let recording = false

            const startRecording = document.getElementById('start-recording')
            const stopRecording = document.getElementById('stop-recording')

            let audioCtx = null
            let mediaSrc = null
            let stream = null

            startRecording.addEventListener('click', function () {
                const handleMediaSource = async function (_stream) {
                    stream = _stream

                    audioCtx = new AudioContext()
                    mediaSrc = audioCtx.createMediaStreamSource(_stream)

                    await audioCtx.audioWorklet.addModule('worklet-processor.js')
                    const worklet = new AudioWorkletNode(audioCtx, 'worklet-processor')

                    mediaSrc.connect(worklet)
                    worklet.connect(audioCtx.destination)

                    recording = true
                }

                navigator.mediaDevices.getUserMedia({ audio: true }).then(handleMediaSource)
            })

            stopRecording.addEventListener('click', function () {
                if (!recording) {
                    return
                }

                stream.getTracks().forEach(function (track) {
                    track.stop()
                })

                mediaSrc.disconnect()
                audioCtx.close()

                recording = false
            })
        })
    </script>
</body>

</html>